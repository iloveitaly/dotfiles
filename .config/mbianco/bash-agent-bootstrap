# bash-agent-bootstrap
# This file is loaded by BASH_ENV for non-interactive bash shells in the agent environment.

# direnv launches a bash subshell, which would pickup on the BASH_ENV config, but we do NOT want to set additional config!
# DIRENV_IN_ENVRC=1 indicates that we are in the direnv-managed subshell. However, this variable is NOT set during BASH_ENV
# loading, so we can't detect it here. For this reason, we need to be very careful about any PATH, shell, etc mutations
# while detecting if we are in an agent terminal.

# Load shared agent logic (path, detection function)
# shellcheck source=./agent-bootstrap
source "${HOME}/.config/mbianco/agent-bootstrap"

# If an agent is running the terminal, load agent config
if ai_is_agent_terminal; then
  # in the case of a bash terminal, mise + direnv should be setup already
  # so all we really need to do is REMOVE stuff that was loaded because we thought it was an interactive shell

    # if agent is already configured, do nothing
  if [[ -n "${AGENT_BASH_CONFIGURED:-}" ]]; then
    [[ ${AGENT_DEBUG:-} -eq 1 ]] && echo "Agent already configured, skipping"
    return 0
  fi

  # TODO unclear if all of this is needed
  unset PROMPT

  # without this, the git config which uses fancy pagers, etc will be used
  export GIT_CONFIG_NOSYSTEM=1
  export GIT_CONFIG_GLOBAL=$HOME/.gitconfig-agent
  export PAGER=cat
  export GIT_PAGER=$PAGER
  export MANPAGER=$PAGER

  # Simple prompt for bash if it happens to be interactive (though BASH_ENV is mostly for non-interactive)
  export PS1='\w $ '

  export AGENT_CONFIGURED=1
  export AGENT_BASH_CONFIGURED=1
fi
